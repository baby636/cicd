#!/usr/bin/env bash -e

[ -z "$configdir" ] && \
    echo "ERROR: configdir was not provided" && \
    exit 1

[ ! -d "$configdir" ] && \
    echo "ERROR: $configdir does not exist" && \
    exit 1

configdir="$(scripts/get_abspath $configdir)"
echo "Cluster configdir is at ${configdir}"

hook=${configdir}/hooks/pre-configure
[ ! -e "${hook}" ] && \
    echo "ERROR: Hook ${hook} does not exist." && \
    exit 1

[ ! -x "${hook}" ] && \
    echo "ERROR: Hook ${hook} exists but is not executable." && \
    exit 1

source $hook

[ -z "${inventory}" ] && \
    echo "ERROR: \$inventory was not defined by hook ${hook}" && \
    exit 1

cd configurator
set -x

ansible-playbook \
    --inventory ${inventory} \
    --extra-vars "@${configdir}/vars.yml" \
    gitlab.yml

{ set +x; } 2>/dev/null
cd - >/dev/null

exit 0
