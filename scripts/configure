#!/usr/bin/env bash -e

[ -z "$configdir" ] && \
    echo "ERROR: configdir was not provided" && \
    exit 1

[ ! -d "$configdir" ] && \
    echo "ERROR: $configdir does not exist" && \
    exit 1

configdir="$(scripts/get_abspath $configdir)"
echo "Cluster configdir is at ${configdir}"

get_inventory_hook=${configdir}/hooks/get-inventory
echo "Looking for inventory script at ${get_inventory_hook}"
[ ! -x "${get_inventory_hook}" ] && \
    echo "ERROR: ${get_inventory_hook} does not exist" && \
    exit 1
# NOTE: The hook may return a comma-delimited string of hostnames/IPs
#       OR a path to an inventory file. Ansible accepts either.
inventory=$($get_inventory_hook)

cd configurator
set -x

ansible-playbook --inventory ${inventory} \
    gitlab.yml

{ set +x; } 2>/dev/null
cd - >/dev/null

exit 0
