---
# Define the CI/CD shared library repos
- name: Ensure project '{{ item }}'
  include_tasks: ensure-project.yml
  vars:
    desired_project: "{{ item }}"
  with_items:
  # This is where changes to the shared library will be merged and
  # tested before it goes to the live repo
  - namespace: "{{ library.namespace | default('cicd') }}"
    name: "{{ library.name | default('library') }}-dev"
    import_url: "{{ library.import_url }}"
    members: "{{ library.members | default([]) }}"

  # Changes that have passed the shared library's pipeline are pushed
  # here and will then be available for use by the projects defined
  # further down this YAML file
  - namespace: "{{ library.namespace | default('cicd') }}"
    name: "{{ library.name | default('library') }}"
    import_url: "{{ library.import_url }}"
    # Nobody should have direct access to the live library. Only the
    # CI job in its dev counterpart should be able to push to it.
    members: []
    builds_access_level: disabled
    forking_access_level: disabled
    issues_access_level: disabled
    merge_requests_access_level: disabled

# Define user projects
- name: Ensure project '{{ item }}'
  include_tasks: ensure-project.yml
  vars:
    desired_project: "{{ item }}"
  with_items: "{{ projects }}"
